# Story 7.1: Terraform Foundation & AWS Networking

---

## Status

**Done**

---

## Story

**As a** DevOps engineer,
**I want** a Terraform project scaffolded with AWS networking infrastructure (VPC, subnet, internet gateway, security group),
**so that** subsequent stories can provision compute and storage resources into a secure, well-defined network.

---

## Acceptance Criteria

1. `infra/` directory created at project root with `main.tf`, `variables.tf`, `outputs.tf`, `terraform.tfvars.example`
2. `.gitignore` updated to exclude `infra/.terraform/`, `*.tfstate*`, `*.tfstate.backup`, and `terraform.tfvars`
3. AWS provider configured with `region` variable (default: `ap-southeast-1`)
4. VPC created with CIDR `10.0.0.0/16` and DNS support/hostnames enabled
5. Public subnet created with CIDR `10.0.1.0/24`, auto-assign public IP enabled
6. Internet gateway created and attached to VPC; route table with `0.0.0.0/0` → IGW associated with subnet
7. Security group created allowing inbound SSH (22) from configurable CIDR, HTTP (80), HTTPS (443) from `0.0.0.0/0`; outbound all traffic
8. `terraform init` succeeds and `terraform plan` shows all expected resources without errors

---

## Tasks / Subtasks

- [x] **Task 1: Create Terraform project scaffolding** (AC: 1, 2)
  - [x] Create `infra/` directory at project root
  - [x] Create `infra/main.tf` with:
    - `terraform` block requiring AWS provider `~> 5.0` and Terraform `>= 1.5`
    - `provider "aws"` block using `var.aws_region`
  - [x] Create `infra/variables.tf` with input variables:
    - `aws_region` (string, default `"ap-southeast-1"`)
    - `project_name` (string, default `"hnpal"`)
    - `environment` (string, default `"production"`)
    - `allowed_ssh_cidr` (string, default `"0.0.0.0/0"`, description notes to restrict in production)
  - [x] Create `infra/outputs.tf` (empty initially, will be populated in later stories)
  - [x] Create `infra/terraform.tfvars.example` with example values (no secrets)
  - [x] Update root `.gitignore` to add:
    ```
    # Terraform
    infra/.terraform/
    infra/*.tfstate
    infra/*.tfstate.backup
    infra/terraform.tfvars
    infra/.terraform.lock.hcl
    ```

- [x] **Task 2: Define VPC** (AC: 4)
  - [x] Create VPC resource in `infra/main.tf`:
    - CIDR block: `10.0.0.0/16`
    - `enable_dns_support = true`
    - `enable_dns_hostnames = true`
    - Tags: `Name = "${var.project_name}-vpc"`

- [x] **Task 3: Create public subnet** (AC: 5)
  - [x] Create subnet resource:
    - VPC ID: reference VPC from Task 2
    - CIDR block: `10.0.1.0/24`
    - Availability zone: `"${var.aws_region}a"`
    - `map_public_ip_on_launch = true`
    - Tags: `Name = "${var.project_name}-public-subnet"`

- [x] **Task 4: Configure internet gateway and routing** (AC: 6)
  - [x] Create internet gateway resource attached to VPC
  - [x] Create route table resource in VPC
  - [x] Create route: `destination_cidr_block = "0.0.0.0/0"` → internet gateway
  - [x] Create route table association linking subnet to route table
  - [x] Tags on all resources with project name

- [x] **Task 5: Create security group** (AC: 7)
  - [x] Create security group in VPC with description
  - [x] Ingress rules:
    - SSH (port 22) from `var.allowed_ssh_cidr`
    - HTTP (port 80) from `0.0.0.0/0`
    - HTTPS (port 443) from `0.0.0.0/0`
  - [x] Egress rule: all traffic to `0.0.0.0/0`
  - [x] Tags: `Name = "${var.project_name}-sg"`

- [x] **Task 6: Validate Terraform configuration** (AC: 8)
  - [x] Run `terraform init` — provider AWS v5.100.0 downloaded
  - [x] Run `terraform validate` — success
  - [x] Run `terraform plan` — 6 resources planned (VPC, subnet, IGW, route table, route table assoc, security group)
  - [x] Verify no errors or warnings

---

## Dev Notes

### Terraform Version & Provider

Use Terraform >= 1.5 with AWS provider ~> 5.0 (latest stable).

```hcl
terraform {
  required_version = ">= 1.5"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region  = var.aws_region
  profile = var.aws_profile
}
```

### Resource Naming Convention

All resources tagged with:
```hcl
tags = {
  Name        = "${var.project_name}-<resource>"
  Project     = var.project_name
  Environment = var.environment
  ManagedBy   = "terraform"
}
```

### Security Group Notes

- SSH should be restricted to specific IP in production (`allowed_ssh_cidr` variable)
- HTTP/HTTPS open for potential webhook traffic from Telegram
- All outbound allowed (needed for: package installation, API calls to Telegram/OpenAI/HN)

### File Structure After This Story

```
infra/
├── main.tf                  # Provider + VPC + subnet + IGW + routes + SG
├── variables.tf             # aws_region, project_name, environment, allowed_ssh_cidr, aws_profile
├── outputs.tf               # vpc_id, public_subnet_id, security_group_id
└── terraform.tfvars.example # Example values
```

### Prerequisites

- **Terraform >= 1.5** installed locally
- **AWS CLI** installed and configured:
  ```bash
  $ aws configure --profile hnpal
  AWS Access Key ID: AKIA...        # From IAM user
  AWS Secret Access Key: wJal...    # From IAM user
  Default region: ap-southeast-1
  ```
  Terraform reads credentials via `aws_profile` variable (default: `"hnpal"`).
- **AWS IAM user** with `AdministratorAccess` policy (or scoped to VPC/EC2/S3/IAM)
- **SSH Key Pair** created in AWS Console → EC2 → Key Pairs (needed in Story 7.3)

### Testing

**Validation:** `terraform init` + `terraform validate` + `terraform plan`

No `terraform apply` in this story — we only validate the plan. Apply happens in Story 7.3 when the EC2 instance is added.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-23 | 1.0 | Initial story creation (full scope) | BMad Master |
| 2026-02-23 | 2.0 | Rescoped to networking-only (Epic 7 breakdown) | BMad Master |
| 2026-02-23 | 2.1 | Added Terraform auth prereqs, t3.micro target | BMad Master |

---

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-6

### Debug Log References

- Fixed: `terraform plan` failed with "No valid credential sources found" — default AWS profile had broken SSO cache. Fix: added `aws_profile` variable + `profile = var.aws_profile` to provider block to use `[hnpal]` profile from `~/.aws/credentials`.
- Fixed: IAM role description contained em dash (`—`) rejected by AWS API (Story 7.3). ASCII-only characters required.

### Completion Notes List

- Added `aws_profile` variable (default `"hnpal"`) beyond story spec — required to handle multiple AWS CLI profiles.
- `locals { common_tags }` block placed at bottom of `main.tf` for shared tagging across all resources.
- `terraform init` installed AWS provider v5.100.0.
- `terraform plan` confirmed 6 networking resources — all created successfully in Story 7.3 apply.

### File List

- `infra/main.tf`
- `infra/variables.tf`
- `infra/outputs.tf`
- `infra/terraform.tfvars.example`
- `.gitignore` (updated)

---

## QA Results

All AC verified via `terraform validate` + `terraform plan` output. Resources confirmed created in AWS during Story 7.3 `terraform apply`:
- VPC: `vpc-047712fd151f0c9af`
- Subnet: `subnet-0e40a7a2ea8885623`
- IGW: `igw-042c777b071a28ce9`
- Route table: `rtb-087fde6ad57b34775`
- Security group: `sg-00314f3524e210279`
