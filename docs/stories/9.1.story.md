# Story 9.1: Inline Button Redesign â€” Show More, Actions Menu, Remove Discuss UI

<!-- Source: Epic 9 â€” Inline Button Refresh -->
<!-- Context: Redesign digest inline buttons for compact layout with menu-swap pattern -->

---

## Status

**Draft**

---

## Story

**As a** Telegram bot user receiving a daily HN digest,
**I want** a compact set of inline buttons with a "Show More" option to expand summaries and an "Actions" menu for reactions,
**so that** the digest feels clean and focused, I can read full summaries in-place, and I can still rate and save posts without clutter.

---

## Background & Scope

The current inline keyboard uses two rows with a Discuss button that sees low engagement:

```
Row 1: [ ğŸ’¬ Discuss ]  [ ğŸ‘ ]  [ ğŸ‘ ]
Row 2: [ ğŸ”– Save for later ]
```

This story replaces it with a single-row, three-button **default menu** and a swappable **reactions menu**:

**Default menu:**
```
[ ğŸ“– More ]  [ ğŸ”– Save ]  [ âš¡ Actions ]
```

**Reactions menu (after tapping Actions):**
```
[ ğŸ‘ Good Response ]  [ ğŸ‘ Bad Response ]  [ Â« Back ]
```

Changes:
1. **New "ğŸ“– More" button** â€” uses `edit_message_text` to show the full (untruncated) summary; records `show_more` in `user_activity_log`.
2. **"ğŸ”– Save" button** â€” same callback data and handler logic as today; label shortened from "ğŸ”– Save for later" to "ğŸ”– Save".
3. **"âš¡ Actions" button** â€” swaps the keyboard to the reactions menu via `edit_message_reply_markup`.
4. **"Â« Back" button** â€” swaps the keyboard back to the default menu.
5. **Discuss button removed from UI** â€” `handle_discuss` handler and FSM logic are **not deleted**, just no longer rendered in the keyboard.

---

## Acceptance Criteria

### AC-1 Â· Default keyboard layout

Every delivered post message shows a single-row inline keyboard:

```
[ ğŸ“– More ]  [ ğŸ”– Save ]  [ âš¡ Actions ]
```

### AC-2 Â· Show More expands summary inline

When the user taps ğŸ“– More:
- The message text is edited (`edit_message_text`) to show the **full untruncated summary** (up to 4000 chars; truncate with "..." if exceeding Telegram's 4096-char limit)
- A new row is inserted into `user_activity_log` with `action_type = "show_more"`
- The keyboard is updated: the ğŸ“– More button is **removed** from the keyboard, leaving:
  ```
  [ ğŸ”– Save ]  [ âš¡ Actions ]
  ```
- A Telegram callback alert appears: **"ğŸ“– Full summary loaded"**

### AC-3 Â· Save button works identically

When the user taps ğŸ”– Save:
- Same behaviour as the existing `handle_save_post` handler
- `user_activity_log` row with `action_type = "save"` (existing)
- Telegram alert: **"ğŸ”– Post saved for later reading!"** (unchanged)
- `callback_data` pattern: `save_post_{post_id}` (unchanged)

### AC-4 Â· Actions button swaps to reactions menu

When the user taps âš¡ Actions:
- The inline keyboard is replaced via `edit_message_reply_markup` with:
  ```
  [ ğŸ‘ Good Response ]  [ ğŸ‘ Bad Response ]  [ Â« Back ]
  ```
- Telegram callback alert: **"Choose a reaction"**
- No event is logged for the menu swap itself

### AC-5 Â· Good / Bad response buttons work identically to existing reactions

When the user taps ğŸ‘ Good Response or ğŸ‘ Bad Response (from the reactions menu):
- Same behaviour as existing `handle_react_up` / `handle_react_down` handlers
- `deliveries.reaction` update still occurs (no regression)
- `user_activity_log` row with `action_type = "rate_up"` or `"rate_down"` (existing)
- Telegram alerts unchanged
- `callback_data` patterns: `react_up_{post_id}`, `react_down_{post_id}` (unchanged)
- After reacting, keyboard swaps back to the default menu (without ğŸ“– More if already expanded)

### AC-6 Â· Back button returns to default menu

When the user taps Â« Back:
- The inline keyboard is replaced via `edit_message_reply_markup` with the default menu
- If the summary was already expanded (ğŸ“– More was previously tapped), the default menu renders without the More button:
  ```
  [ ğŸ”– Save ]  [ âš¡ Actions ]
  ```
- Telegram callback alert: none (silent, `show_alert=False`)

### AC-7 Â· Discuss button removed from UI only

- The `ğŸ’¬ Discuss` button no longer appears in the inline keyboard
- `handle_discuss` handler, `BotStates.DISCUSSION`, and all FSM logic remain in `callbacks.py` â€” **no code deleted**
- If `discuss_{post_id}` callback is somehow triggered (e.g., old cached messages), the existing handler still responds

### AC-8 Â· Failures are graceful

- If `edit_message_text` fails (e.g., message too old to edit), log warning and reply with callback alert: **"ğŸ“– Could not expand â€” try the article link above"**
- If `edit_message_reply_markup` fails, log warning and answer callback silently
- If `user_activity_log` insert fails, log warning, continue â€” UX is not broken

### AC-9 Â· Batch header keyboard unchanged

- `build_batch_keyboard()` and its "ğŸ“– View Posts" button are **not modified**

---

## Data Model

**No new tables or columns.** This story uses the existing `user_activity_log` table (from Story 8.4).

New `action_type` value added: `"show_more"` (append-only log, no schema change needed â€” `action_type` is `String(20)`).

---

## Dev Technical Guidance

### Files to change

| File | Change |
|------|--------|
| `presentation/bot/formatters/digest_formatter.py` | Rewrite `build_post_keyboard()` to return default menu; add `build_reactions_keyboard()` and `build_default_keyboard_without_more()` |
| `presentation/bot/handlers/callbacks.py` | Add `handle_show_more`, `handle_actions_menu`, `handle_back_to_default`; modify `handle_react_up`/`handle_react_down` to swap back to default after reacting |
| `presentation/bot/formatters/digest_formatter.py` | Update `DigestMessageFormatter` to expose a method for the full (untruncated) summary |

### Callback data format

| Button | `callback_data` | Handler |
|--------|-----------------|---------|
| ğŸ“– More | `show_more_{post_id}` | `handle_show_more` (new) |
| ğŸ”– Save | `save_post_{post_id}` | `handle_save_post` (existing, unchanged) |
| âš¡ Actions | `actions_{post_id}` | `handle_actions_menu` (new) |
| ğŸ‘ Good Response | `react_up_{post_id}` | `handle_react_up` (existing, modified to swap back) |
| ğŸ‘ Bad Response | `react_down_{post_id}` | `handle_react_down` (existing, modified to swap back) |
| Â« Back | `back_{post_id}` | `handle_back_to_default` (new) |

### Keyboard builder methods

```python
class InlineKeyboardBuilder:

    def build_post_keyboard(self, post_id: str) -> Dict[str, Any]:
        """Default menu: [ ğŸ“– More ] [ ğŸ”– Save ] [ âš¡ Actions ]"""

    def build_post_keyboard_without_more(self, post_id: str) -> Dict[str, Any]:
        """Default menu after expansion: [ ğŸ”– Save ] [ âš¡ Actions ]"""

    def build_reactions_keyboard(self, post_id: str) -> Dict[str, Any]:
        """Reactions menu: [ ğŸ‘ ] [ ğŸ‘ ] [ Â« Back ]"""
```

### Show More handler flow

```
User taps ğŸ“– More
  â†’ extract post_id from callback_data ("show_more_{post_id}")
  â†’ load post from DB (need full summary text)
  â†’ rebuild message text with full untruncated summary
  â†’ call edit_message_text(text=full_text, reply_markup=keyboard_without_more)
  â†’ try: insert user_activity_log(action_type="show_more")
    except: log warning
  â†’ answer_callback_query("ğŸ“– Full summary loaded")
```

### Actions / Back handler flow

```
User taps âš¡ Actions
  â†’ extract post_id from callback_data ("actions_{post_id}")
  â†’ call edit_message_reply_markup(reply_markup=reactions_keyboard)
  â†’ answer_callback_query("Choose a reaction")

User taps Â« Back
  â†’ extract post_id from callback_data ("back_{post_id}")
  â†’ determine if More was already used (check if current message text length > SUMMARY_TRUNCATE_LENGTH)
  â†’ call edit_message_reply_markup(reply_markup=default_or_without_more_keyboard)
  â†’ answer_callback_query(silent)
```

### React-then-swap-back pattern

After `handle_react_up` / `handle_react_down` complete their existing logic, add:

```python
# Swap keyboard back to default menu after reaction
try:
    keyboard = builder.build_post_keyboard(post_id)  # or without_more variant
    await callback.message.edit_reply_markup(reply_markup=InlineKeyboardMarkup(**keyboard))
except Exception:
    pass  # Best-effort swap, don't fail the reaction
```

### Determining "More already expanded" state

Rather than storing state in Redis/DB, infer from message text length:
- If `len(callback.message.text) > SUMMARY_TRUNCATE_LENGTH + 50` â†’ summary was expanded â†’ use `build_post_keyboard_without_more`
- Otherwise â†’ use `build_post_keyboard` (with More button)

This avoids any new state management.

### DigestMessageFormatter changes

Add a method to format the full summary message (untruncated):

```python
def format_post_message_full(self, post: Post, position: int, total: int) -> str:
    """Same as format_post_message but without summary truncation."""
```

This reuses the same structure but skips the `SUMMARY_TRUNCATE_LENGTH` cut.

### Existing code preservation

- `handle_discuss` at `callbacks.py:30-78` â€” **do not delete or modify**
- `BotStates.DISCUSSION` â€” **do not delete**
- The Discuss handler will still respond to any `discuss_{post_id}` callbacks from old cached messages

---

## Tasks / Subtasks

- [ ] **Task 1 â€” Keyboard builder methods** (AC: 1, 4, 6)
  - [ ] Rewrite `build_post_keyboard(post_id)` â†’ returns single-row `[ ğŸ“– More ] [ ğŸ”– Save ] [ âš¡ Actions ]`
  - [ ] Add `build_post_keyboard_without_more(post_id)` â†’ returns `[ ğŸ”– Save ] [ âš¡ Actions ]`
  - [ ] Add `build_reactions_keyboard(post_id)` â†’ returns `[ ğŸ‘ Good Response ] [ ğŸ‘ Bad Response ] [ Â« Back ]`
  - [ ] Verify `build_batch_keyboard()` is unchanged (AC-9)

- [ ] **Task 2 â€” DigestMessageFormatter: full summary method** (AC: 2)
  - [ ] Add `format_post_message_full(post, position, total)` method that formats without truncation
  - [ ] Ensure output respects 4000-char safety limit (truncate with "..." if over)

- [ ] **Task 3 â€” Show More handler** (AC: 2, 8)
  - [ ] Register `handle_show_more` on `F.data.startswith("show_more_")`
  - [ ] Load post from DB, format full message text
  - [ ] Call `edit_message_text` with full text + `build_post_keyboard_without_more` keyboard
  - [ ] Insert `user_activity_log` row with `action_type = "show_more"` (try/except, AC-8)
  - [ ] Answer callback with "ğŸ“– Full summary loaded"
  - [ ] Handle `edit_message_text` failures gracefully (AC-8)

- [ ] **Task 4 â€” Actions menu swap handler** (AC: 4)
  - [ ] Register `handle_actions_menu` on `F.data.startswith("actions_")`
  - [ ] Call `edit_message_reply_markup` with `build_reactions_keyboard`
  - [ ] Answer callback with "Choose a reaction"

- [ ] **Task 5 â€” Back handler** (AC: 6)
  - [ ] Register `handle_back_to_default` on `F.data.startswith("back_")`
  - [ ] Determine whether More was already used (infer from message text length)
  - [ ] Call `edit_message_reply_markup` with appropriate default keyboard variant
  - [ ] Answer callback silently

- [ ] **Task 6 â€” Modify react handlers to swap back** (AC: 5)
  - [ ] In `handle_react_up`: after existing logic, swap keyboard back to default menu (best-effort)
  - [ ] In `handle_react_down`: same pattern
  - [ ] Verify existing `deliveries.reaction` write and `user_activity_log` insert are not affected

- [ ] **Task 7 â€” Verify Discuss handler preserved** (AC: 7)
  - [ ] Confirm `handle_discuss` is still registered and functional
  - [ ] Confirm no import or code removal in callbacks.py for discuss-related code

- [ ] **Task 8 â€” Regression checks** (AC: 3, 5, 7, 9)
  - [ ] Smoke-test ğŸ”– Save flow end-to-end
  - [ ] Smoke-test ğŸ‘ / ğŸ‘ flow end-to-end (via Actions menu)
  - [ ] Smoke-test Discuss handler responds if triggered manually
  - [ ] Smoke-test batch header keyboard unchanged
  - [ ] Verify `user_activity_log` rows for `show_more`, `save`, `rate_up`, `rate_down`

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| `edit_message_text` fails on messages older than 48 hours | Low | Low | Graceful fallback alert (AC-8); most interactions happen within minutes of delivery |
| Callback data prefix collision (`back_` vs other patterns) | Low | Medium | Use specific prefix `back_`; no existing handlers use this prefix |
| Inferred "expanded" state is wrong (edge case: short full summary) | Low | Low | Worst case: More button reappears on a post that was already expanded â€” harmless |
| Users miss ğŸ‘/ğŸ‘ now that they're behind Actions | Medium | Low | Actions label signals interactivity; users who care about rating will tap; reduces accidental taps |

### Rollback Plan

1. Revert `build_post_keyboard()` to original two-row layout (Discuss + reactions + Save).
2. Remove new handlers (`handle_show_more`, `handle_actions_menu`, `handle_back_to_default`).
3. Revert react handler modifications (remove swap-back logic).
4. All existing tables and data remain untouched â€” rollback is safe.

---

## Out of Scope (Explicitly)

- Deleting `handle_discuss` handler or `BotStates.DISCUSSION` FSM
- Any new database tables or columns
- A "Show Less" / collapse-back behaviour after expanding
- Animated transitions or button highlight effects
- `/discuss` command as alternative to inline button
- Analytics dashboard for `show_more` events

---

## Testing

**Test file location:** `tests/unit/presentation/bot/`

**Existing tests to verify pass:**
- All tests in `tests/unit/presentation/bot/handlers/test_callbacks.py`
- All tests in `tests/unit/presentation/bot/formatters/`

**New test coverage:**
- `build_post_keyboard` returns correct three-button single-row layout
- `build_post_keyboard_without_more` returns correct two-button layout
- `build_reactions_keyboard` returns correct three-button layout with Back
- `handle_show_more` calls `edit_message_text` and inserts `show_more` activity log
- `handle_actions_menu` calls `edit_message_reply_markup` with reactions keyboard
- `handle_back_to_default` calls `edit_message_reply_markup` with default keyboard
- `handle_react_up` / `handle_react_down` swap keyboard back after reaction

**Testing framework:** pytest + pytest-asyncio (following existing patterns)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Initial draft | BMad Master |
