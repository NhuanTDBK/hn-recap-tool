# Story 8.4: Summary Feedback (ğŸ‘ / ğŸ‘) & Save for Later

<!-- Source: Brownfield enhancement â€” brainstorming session 2026-02-25 -->
<!-- Context: Adds feedback tracking and save-for-later to the Telegram bot digest delivery -->

---

## Status

**Draft**

---

## Story

**As a** Telegram bot user receiving a daily HN digest,
**I want to** rate the AI-generated summary with a thumbs-up or thumbs-down, and optionally save the post for future reading,
**so that** my feedback is recorded for quality tracking and I can bookmark interesting posts without leaving the chat.

---

## Background & Scope

The digest bot renders inline buttons (ğŸ’¬ Discuss, ğŸ‘, ğŸ‘) on every delivered post message. The ğŸ‘/ğŸ‘ handlers currently write to `deliveries.reaction`. This story:

1. **Introduces a new `user_activity_log` table** â€” append-only, one row per user action.
2. **Adds a ğŸ”– Save button** alongside the existing reaction buttons.
3. **Records every tap** (rate up, rate down, save) as an immutable log entry â€” no existing table is modified.
4. **Shows immediate user-visible confirmation** via Telegram alert on each tap.
5. **Records only** â€” no downstream personalization, no ranking changes, no triggers.

The existing `deliveries.reaction` column and its write path are **left untouched** â€” they continue to work as before. This story adds on top of them.

---

## Acceptance Criteria

### AC-1 Â· Updated inline keyboard layout

Every delivered post message shows a two-row inline keyboard:

```
Row 1:  [ ğŸ’¬ Discuss ]  [ ğŸ‘ ]  [ ğŸ‘ ]
Row 2:  [ ğŸ”– Save for later ]
```

### AC-2 Â· Thumbs-up inserts an activity log entry

When the user taps ğŸ‘:
- A new row is inserted into `user_activity_log` with `action_type = "rate_up"`
- A Telegram answer-callback alert appears: **"ğŸ‘ Summary rated helpful â€” thanks!"**
- The existing `deliveries.reaction = "up"` write still occurs (no regression)

### AC-3 Â· Thumbs-down inserts an activity log entry

When the user taps ğŸ‘:
- A new row is inserted into `user_activity_log` with `action_type = "rate_down"`
- A Telegram answer-callback alert appears: **"ğŸ‘ Noted â€” thanks for the feedback!"**
- The existing `deliveries.reaction = "down"` write still occurs (no regression)

### AC-4 Â· Re-tapping always inserts a new row (append-only)

- Every tap appends a new row regardless of prior actions.
- No deduplication, no upsert. The log is the truth.

### AC-5 Â· Save for later inserts an activity log entry

When the user taps ğŸ”–:
- A new row is inserted into `user_activity_log` with `action_type = "save"`
- A Telegram answer-callback alert appears: **"ğŸ”– Post saved for later reading!"**

### AC-6 Â· Failures are graceful

- If the log insert fails (DB error), the handler logs the error, continues, and still replies with the confirmation alert â€” the UX is not broken by a failed write.

### AC-7 Â· No personalization side-effects

- The `user_activity_log` table is not read by any delivery-selection, scoring, or summarization use-case in this story.
- Existing jobs (`hourly_delivery_job`, `personalized_summarization`) are unchanged.

### AC-8 Â· Existing ğŸ’¬ Discuss behaviour is unaffected

- The Discuss button and its FSM flow work exactly as before.

---

## Data Model â€” `user_activity_log` (new table)

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| `id` | UUID | PK, default uuid4() | |
| `user_id` | Integer | FK â†’ `users.id`, NOT NULL, INDEX | Cascade delete |
| `post_id` | UUID | FK â†’ `posts.id`, NOT NULL, INDEX | Cascade delete |
| `action_type` | String(20) | NOT NULL, INDEX | `"rate_up"` Â· `"rate_down"` Â· `"save"` |
| `created_at` | TIMESTAMP(tz) | NOT NULL, server_default=now(), INDEX | Append time |

**No other table is altered.**

---

## Dev Technical Guidance

### Files to change

| File | Change |
|------|--------|
| `infrastructure/database/models.py` | Add `UserActivityLog` ORM model |
| `infrastructure/database/alembic/` | New migration: create `user_activity_log` table |
| `application/interfaces.py` | Add `IActivityLogRepository` interface with `log_activity()` |
| `infrastructure/repositories/postgres/` | Add `activity_log_repo.py` implementing `IActivityLogRepository` |
| `presentation/bot/formatters/digest_formatter.py` | Update `InlineKeyboardBuilder.build_post_keyboard()` â€” add ğŸ”– row |
| `presentation/bot/handlers/callbacks.py` | Extend `handle_react_up` / `handle_react_down`; add `handle_save_post` |

### Repository interface (new)

`IActivityLogRepository` needs one method:

```
log_activity(user_id: int, post_id: str, action_type: str) -> dict
```

Returns the inserted row as a dict. `action_type` is one of: `"rate_up"`, `"rate_down"`, `"save"`.

### Callback data format

| Button | `callback_data` | Handler |
|--------|-----------------|---------|
| ğŸ‘ | `react_up_{post_id}` | `handle_react_up` (existing, extended) |
| ğŸ‘ | `react_down_{post_id}` | `handle_react_down` (existing, extended) |
| ğŸ”– | `save_post_{post_id}` | `handle_save_post` (new) |

### Handler flow pattern (same for all three)

```
User taps button
  â†’ extract post_id from callback_data
  â†’ look up user by telegram_id
  â†’ [existing delivery.reaction write if ğŸ‘/ğŸ‘ â€” keep as-is]
  â†’ try:
      insert row into user_activity_log
    except:
      log warning (do not re-raise)
  â†’ answer_callback_query with confirmation text
```

### Keyboard layout target

`build_post_keyboard(post_id)` currently returns a single-row inline keyboard. It should return two rows:

```
Row 1: [ğŸ’¬ Discuss]  [ğŸ‘]  [ğŸ‘]
Row 2: [ğŸ”– Save for later]
```

Only this method changes. `build_batch_keyboard()` is untouched.

### Dependency injection

The `IActivityLogRepository` should be injected into callback handlers the same way `AsyncSession` is currently injected â€” via aiogram middleware or a dependency factory already in place. Follow the pattern used by `delivery_repo` in existing handlers.

---

## Tasks / Subtasks

- [ ] **Task 1 â€” New DB model & migration**
  - [ ] Add `UserActivityLog` ORM model to `models.py` with columns per the data model above
  - [ ] Add cascade-delete relationship from `User` â†’ `UserActivityLog` and `Post` â†’ `UserActivityLog`
  - [ ] Generate Alembic migration: `create table user_activity_log`
  - [ ] Verify migration runs cleanly on local dev DB and is reversible (`downgrade`)

- [ ] **Task 2 â€” Repository layer**
  - [ ] Add `IActivityLogRepository` abstract interface to `application/interfaces.py`
  - [ ] Create `infrastructure/repositories/postgres/activity_log_repo.py`
  - [ ] Implement `log_activity(user_id, post_id, action_type)` â€” simple insert, returns inserted row dict
  - [ ] Register repo in the DI container / session factory following existing repo patterns

- [ ] **Task 3 â€” Keyboard formatter**
  - [ ] Update `InlineKeyboardBuilder.build_post_keyboard(post_id)` to produce two-row keyboard
  - [ ] Row 1: Discuss, ğŸ‘, ğŸ‘ (existing buttons, unchanged `callback_data`)
  - [ ] Row 2: ğŸ”– Save for later with `callback_data = "save_post_{post_id}"`

- [ ] **Task 4 â€” Callback handlers**
  - [ ] In `handle_react_up`: after the existing `delivery.reaction` write, call `log_activity(user_id, post_id, "rate_up")` wrapped in try/except; update alert text to match AC-2
  - [ ] In `handle_react_down`: same pattern with `"rate_down"` and alert text per AC-3
  - [ ] Add `handle_save_post` registered on `F.data.startswith("save_post_")`: look up user, call `log_activity(..., "save")`, reply with alert per AC-5

- [ ] **Task 5 â€” Regression checks**
  - [ ] Confirm ğŸ’¬ Discuss handler still fires correctly after keyboard layout change
  - [ ] Confirm existing `deliveries.reaction = "up"/"down"` write still happens in updated handlers
  - [ ] Confirm `UserActivityLog` rows are inserted correctly for all three action types via manual smoke-test

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Alembic migration conflicts with existing migrations on prod | Low | Medium | Test migration against a prod schema snapshot before deploying |
| `log_activity` DB error silently swallowed breaks user trust | Low | Low | AC-6: error is logged; alert still fires; monitor via existing error logging |
| Keyboard change shifts button row indices, breaking Discuss FSM | Low | Medium | Smoke-test Discuss flow after formatter change; row 1 buttons are unchanged |
| DI wiring for new repo is non-trivial if DI container is implicit | Medium | Low | Follow exact pattern of how `delivery_repo` is injected in current handlers |

### Rollback Plan

1. `alembic downgrade -1` drops `user_activity_log` (no data loss on existing tables).
2. Revert `models.py`, `interfaces.py`, `activity_log_repo.py`.
3. Revert keyboard formatter to single-row.
4. Revert handler changes (restore original alert texts, remove `log_activity` calls).
5. All existing tables remain untouched throughout â€” rollback is fully safe.

---

## Out of Scope (Explicitly)

- Mutating `summaries.rating` or adding columns to `deliveries`
- Personalization or delivery scoring based on activity log data
- A `/saved` command to retrieve saved posts
- Analytics endpoint or dashboard over `user_activity_log`
- Deduplication or "already voted" guard logic
- Decay, expiry, or archival of log entries
- Any read path on `user_activity_log` in this story
