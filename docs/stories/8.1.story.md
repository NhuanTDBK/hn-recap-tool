# Story 8.1: Fix Summarizer Watermark — hn_id → collected_at Rolling Window

---

## Status

**Done**

---

## Story

**As a** system operator,
**I want** the summarizer to find all newly collected posts regardless of their HN creation order,
**so that** late-arriving posts (posts that crossed the score threshold hours/days after creation) are never silently skipped.

---

## Acceptance Criteria

1. `find_posts_by_id_range` is replaced with a new function `find_unsummarized_posts` that queries `collected_at >= NOW() - INTERVAL '48 hours'` combined with `NOT EXISTS (summary for this user/group)`
2. `get_group_post_id_window` is replaced with logic that derives the lookback anchor from `collected_at`, not `hn_id`
3. The 85 currently stuck posts (diagnosed on 2026-02-25) are picked up and summarized on the next summarizer run after deploy
4. No previously summarized post is re-summarized (the `NOT EXISTS` check in `filter_posts_for_user` ensures idempotency)
5. The 48-hour window is configurable via a constant or settings parameter (`SUMMARIZER_LOOKBACK_HOURS`, default `48`)
6. Summarizer logs clearly state the lookback window being used, e.g. `"Scanning posts collected since {timestamp} (48h window)"`
7. All existing summarizer tests pass; new unit test added covering the late-arrival scenario

---

## Tasks / Subtasks

- [x] **Task 1: Replace watermark query in `personalized_summarization.py`** (AC: 1, 2, 5, 6)
  - [x] Remove `get_user_last_summary_post_id` and `get_group_post_id_window` functions (hn_id based) — kept as deprecated stubs
  - [x] Add `SUMMARIZER_LOOKBACK_HOURS = 48` constant at module top
  - [x] Add new function `find_unsummarized_posts(session, lookback_hours, limit)` using `collected_at >= since`
  - [x] Update `run_personalized_summarization` to call `find_unsummarized_posts` instead of the hn_id window functions
  - [x] Add log line: `"Scanning posts collected since {since.isoformat()} ({lookback_hours}h window)"`
  - [x] Old hn_id functions kept as deprecated stubs with a comment block

- [x] **Task 2: Verify `filter_posts_for_user` still guards against re-summarization** (AC: 4)
  - [x] Confirmed `filter_posts_for_user` filters out posts with existing summaries before any API call
  - [x] Added comment clarifying this is the idempotency layer (Story 8.1)

- [x] **Task 3: Update `run_personalized_summarization.py` script defaults** (AC: 5)
  - [x] Updated `--default-hours` default from 6 → 48, updated help text and log labels

- [x] **Task 4: Add unit test for late-arrival scenario** (AC: 7)
  - [x] Added `test_summarizer_catches_late_arrival` to `test_personalized_summarization.py`
  - [x] Added `test_find_unsummarized_posts_returns_posts_in_window`
  - [x] Added `test_find_unsummarized_posts_with_limit`
  - [x] Added `test_filter_posts_for_user_excludes_already_summarized`
  - [x] All 18 tests pass

- [ ] **Task 5: Manual verification on remote** (AC: 3)
  - [ ] After deploy, check summarizer logs show `"Scanning posts collected since …"`
  - [ ] Query DB: `SELECT COUNT(*) FROM posts WHERE type='story' AND collected_at >= NOW() - INTERVAL '48 hours' AND NOT EXISTS (SELECT 1 FROM summaries WHERE post_id = posts.id AND user_id = 1)` — should drop from 85 to 0 after one summarizer cycle

---

## Dev Notes

### Root Cause (from 2026-02-25 diagnosis)

The original implementation used `MAX(Post.hn_id)` of the user's existing summaries as a forward cursor. HN assigns `hn_id` at post creation time, not at collection time. Posts that only crossed the score threshold (≥50) hours/days later are inserted into the DB with a fresh `collected_at` but an old `hn_id` — permanently below the watermark.

The first-run fallback (`ORDER BY hn_id DESC LIMIT 10`) made this worse: it jumped the watermark to the top 10 hn_ids from the initial batch of ~100, instantly stranding 79 posts from the same batch.

**Evidence from DB (2026-02-25):**
- 115 total posts collected, 30 summarized, **85 stuck**
- Watermark: `hn_id = 47145963`, `collected_at = 2026-02-25 03:00:45 UTC`
- Posts like "Americans destroying Flock cameras" (score 650), "Keep Android Open" (score 2234) stuck with hn_id below watermark

### Why `collected_at >= NOW() - 48h` is correct and efficient

- `collected_at` is set by our collector to `NOW()` at insert time — always fresh
- Late arrivals get a recent `collected_at` regardless of their `hn_id`
- The 48h window is a fixed-size scan: ~200–300 posts max, regardless of total DB size
- `NOT EXISTS` with index `summaries(user_id, post_id)` is fast over the small window set
- `filter_posts_for_user` (existing code) provides secondary deduplication before API calls

### Key Files

| File | Change |
|---|---|
| `backend/app/application/use_cases/personalized_summarization.py` | Primary change — replace watermark functions |
| `backend/scripts/run_personalized_summarization.py` | Check/remove CLI args for old `--default-hours` |
| `backend/tests/test_personalized_summarization.py` | Add late-arrival test |

### Existing Pattern Reference

`filter_posts_for_user` at line ~335 already does per-user deduplication using `NOT EXISTS` pattern — the new `find_unsummarized_posts` follows the same style at the group query level.

### Future: Index on `collected_at` (not in scope)

The `posts.collected_at` column has no index. The outer query in `find_unsummarized_posts` filters on `collected_at >= since`, so PostgreSQL falls back to using `ix_posts_type` and scanning all story rows. At current scale (~200–300 posts in a 48h window) this is acceptable.

When the table grows, add a partial composite index via a new Alembic migration:

```sql
CREATE INDEX ix_posts_collected_at_type
ON posts (collected_at DESC, type)
WHERE is_dead = FALSE AND is_deleted = FALSE;
```

This eliminates the `is_dead`/`is_deleted` filter cost and lets PostgreSQL seek directly into the 48h window. The `NOT EXISTS` side on `summaries` is already covered by the existing `ix_summaries_post_user (post_id, user_id)` index — no change needed there.

### Testing

- Test framework: pytest + pytest-asyncio (existing project standard)
- Test DB: use existing test fixtures with in-memory or test PostgreSQL session
- Run: `uv run pytest backend/tests/ -v`

---

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2026-02-25 | 1.0 | Initial story — diagnosed watermark bug on remote PostgreSQL | BMad Master |

---

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-6

### Debug Log References

None — no debug issues encountered during implementation.

### Completion Notes List

- Deprecated `get_user_last_summary_post_id`, `get_group_post_id_window`, `find_posts_by_id_range`, `get_group_time_window`, `find_posts_in_time_window` (left as stubs with deprecation comments — safe to remove in a future cleanup sprint)
- `default_hours` parameter in `run_personalized_summarization` is now meaningful again (was "Deprecated (not used)" under hn_id approach) — default changed to 48
- Task 5 (manual remote verification) left open; must be done post-deploy

### File List

- `backend/app/application/use_cases/personalized_summarization.py`
- `backend/scripts/run_personalized_summarization.py`
- `backend/tests/application/use_cases/test_personalized_summarization.py`

---

## QA Results

_To be filled by QA Agent_
